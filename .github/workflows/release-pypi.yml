---
name: Release Version to PYPI

on:
  # Create pypi release if tag is pushed to main.
  # Needs: secrets.PLATOMO_BUILDER_ACCESS
  push:
    tags:
      - "v*.*.*.*"

permissions:
  id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing
  contents: read  # Adjust other permissions as necessary
  actions: read

jobs:
  test:
    if: endsWith(github.event.base_ref, 'main')
    uses: './.github/workflows/test.yml'
  regression-test:
    if: endsWith(github.event.base_ref, 'main')
    uses: './.github/workflows/regression-test.yml'
    secrets: inherit
  create-pypi-release:
    runs-on: ubuntu-latest
    needs:
      - test
      - regression-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Update Version
        uses: platomo/update-version-py-action@main
        with:
          version: ${{ github.ref_name }}
          file-path: OTAnalytics
      - name: Publish Python Package
        uses: platomo/publish-pypi-action@main
        with:
          repository-url: https://test.pypi.org/p/OTAnalytics-EXAMPLE-TEST-DISTRIBUTION
